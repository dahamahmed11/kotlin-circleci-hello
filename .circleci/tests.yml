version: 2.1

parameters:
  run_db_tests:
    type: string
    default: "1"

workflows:
  tests_pipeline:
    jobs:
      - sonarqube:
          filters:
            branches:
              only: dev
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+(-rc.*)?$/

      - tests:
          run_db_tests: << pipeline.parameters.run_db_tests >>
          requires:
            - sonarqube
          filters:
            branches:
              only: dev
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+(-rc.*)?$/

jobs:

  sonarqube:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout
      - run:
          name: SonarQube scan
          command: |
            echo "Running SonarQube scan..."
            if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
              echo "SONAR_HOST_URL or SONAR_TOKEN not set, skipping real scan."
              exit 0
            fi
            echo "Here you would call the real sonar-scanner CLI."

  tests:
    docker:
      - image: cimg/openjdk:17.0
    parameters:
      run_db_tests:
        type: string
        default: "1"
    steps:
      - checkout

      - run:
          name: Make Gradle wrapper executable
          command: chmod +x ./gradlew

      - run:
          name: Run unit tests (with RUN_DB_TESTS)
          command: ./gradlew test
          environment:
            RUN_DB_TESTS: << parameters.run_db_tests >>

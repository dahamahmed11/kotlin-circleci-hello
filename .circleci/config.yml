version: 2.1

parameters:
  run_db_tests:
    type: string
    default: "0"

workflows:
  ci_pipeline:
    jobs:
      - sonarqube:
          filters:
            branches:
              only: dev
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+(-rc.*)?$/

      - build:
          run_db_tests: << pipeline.parameters.run_db_tests >>
          requires:
            - sonarqube
          filters:
            branches:
              only: dev
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+(-rc.*)?$/
      # - request_deployment_approval:
      #     requires:
      #       - build
      # - kustomize_release:
      #     requires:
      #       - build
      #       - request_deployment_approval

jobs:

  sonarqube:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout
      - run:
          name: SonarQube scan
          command: |
            if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
              echo "Skipping scan: SONAR vars not set."
              exit 0
            fi
            echo "Running Sonar (placeholder)"

  build:
    docker:
      - image: cimg/openjdk:17.0
    parameters:
      run_db_tests:
        type: string
        default: "0"

    steps:
      - checkout

      - run:
        name: Set environment and generate .env
        command: |
          set -eo pipefail

          echo "BRANCH=$CIRCLE_BRANCH"
          echo "TAG=$CIRCLE_TAG"

          if [ "$CIRCLE_BRANCH" = "dev" ]; then
            ENVIRONMENT="development"
            ENV_SUFFIX="_DEV"
            echo "Using DEV environment"
          elif [ -n "$CIRCLE_TAG" ] && [[ "$CIRCLE_TAG" == *"-rc"* ]]; then
            ENVIRONMENT="staging"
            ENV_SUFFIX="_STG"
            echo "Using STG environment"
          elif [ -n "$CIRCLE_TAG" ]; then
            ENVIRONMENT="production"
            ENV_SUFFIX="_PRD"
            echo "Using PROD environment"
          else
            echo "ERROR: cannot detect environment"
            exit 1
          fi

          rm -f .env
          touch .env

          echo "-- GLOBAL VARS --"

          env | grep "_GLOBAL" | grep -v "^GHA_" || true | while IFS='=' read -r k v; do
            base="${k%_GLOBAL}"
            echo "${base}=${v}" >> .env
          done

          echo "-- ENVIRONMENT VARS ${ENV_SUFFIX} --"

          env | grep "${ENV_SUFFIX}$" | grep -v "^GHA_" || true | while IFS='=' read -r k v; do
            base="${k%${ENV_SUFFIX}}"
            echo "${base}=${v}" >> .env
          done

          echo "Generated .env:"
          cat .env

          DOCKER_TAG="${DOCKERHUB_USERNAME}/${GHA_IMAGE_NAME}:${CIRCLE_SHA1}"

          echo "export DOCKER_TAG=${DOCKER_TAG}" >> env-exports
          echo "export ENVIRONMENT=${ENVIRONMENT}" >> env-exports


      - persist_to_workspace:
          root: .
          paths:
            - .env
            - env-exports

      - run:
          name: Make Gradle wrapper executable
          command: chmod +x ./gradlew

      - run:
          name: Build & Test Kotlin project
          environment:
            RUN_DB_TESTS: << parameters.run_db_tests >>
          command: ./gradlew build

      - setup_remote_docker

      - run:
          name: Docker build
          command: |
            set -eo pipefail
            source env-exports

            EXTRA_ARGS=""
            while IFS= read -r line; do
              EXTRA_ARGS+=" --build-arg $line"
            done < .env

            docker build -t "${DOCKER_TAG}" ${EXTRA_ARGS} .

      - run:
          name: Login to DockerHub
          command: |
            echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

      - run:
          name: Push Docker image
          command: |
            source env-exports
            docker push "${DOCKER_TAG}"

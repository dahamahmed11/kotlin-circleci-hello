version: 2.1

parameters:
  run_db_tests:
    type: string
    default: "0"

workflows:
  ci_pipeline:
    jobs:
      - sonarqube:
          filters:
            branches:
              only: dev
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+(-rc.*)?$/

      - build:
          run_db_tests: << pipeline.parameters.run_db_tests >>
          requires:
            - sonarqube
          filters:
            branches:
              only: dev
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+(-rc.*)?$/

jobs:

  sonarqube:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout
      - run:
          name: SonarQube scan
          command: |
            echo "Running SonarQube scan..."
            if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
              echo "SONAR_HOST_URL or SONAR_TOKEN not set, skipping real scan."
              exit 0
            fi


  build:
    docker:
      - image: cimg/openjdk:17.0

    parameters:
      run_db_tests:
        type: string
        default: "0"

    steps:
      - checkout

      - run:
          name: Set environment and generate .env
          command: |
            set -eo pipefail

            echo "BRANCH=$CIRCLE_BRANCH"
            echo "TAG=$CIRCLE_TAG"

            if [ "$CIRCLE_BRANCH" = "dev" ]; then
              ENVIRONMENT="development"
              ENV_SUFFIX="_DEV"
              echo "Using DEV environment"
            elif [ -n "$CIRCLE_TAG" ] && [[ "$CIRCLE_TAG" == *"-rc"* ]]; then
              ENVIRONMENT="staging"
              ENV_SUFFIX="_STG"
              echo "Using STG environment"
            elif [ -n "$CIRCLE_TAG" ]; then
              ENVIRONMENT="production"
              ENV_SUFFIX="_PRD"
              echo "Using PROD environment"
            else
              echo "ERROR: cannot detect environment"
              exit 1
            fi

            rm -f .env
            touch .env

            echo "-- GLOBAL VARS --"
            env | grep "_GLOBAL" | grep -v "^GHA_" || true | while IFS='=' read -r k v; do
              base="${k%_GLOBAL}"
              echo "${base}=${v}" >> .env
            done

            echo "-- ENV VARS ${ENV_SUFFIX} --"
            env | grep "${ENV_SUFFIX}$" | grep -v "^GHA_" || true | while IFS='=' read -r k v; do
              base="${k%${ENV_SUFFIX}}"
              echo "${base}=${v}" >> .env
            done

            echo "Generated .env:"
            cat .env

            DOCKER_TAG="${DOCKERHUB_USERNAME}/${GHA_IMAGE_NAME}:${CIRCLE_SHA1}"

            echo "export DOCKER_TAG=${DOCKER_TAG}"  >> env-exports
            echo "export ENVIRONMENT=${ENVIRONMENT}" >> env-exports

      - persist_to_workspace:
          root: .
          paths:
            - env-exports
            - .env

      - run:
          name: Make Gradle wrapper executable
          command: chmod +x ./gradlew

      - run:
          name: Build & Test Kotlin
          command: ./gradlew build
          environment:
            RUN_DB_TESTS: << parameters.run_db_tests >>

      - setup_remote_docker

      - run:
          name: Docker Build
          command: |
            source env-exports
            EXTRA_ARGS=""
            if [ -f .env ]; then
              while IFS= read -r i; do
                EXTRA_ARGS+=" --build-arg $i"
              done < .env
            fi
            echo "Building image: ${DOCKER_TAG}"
            docker build . -t "${DOCKER_TAG}" ${EXTRA_ARGS}

      - run:
          name: Docker Login & Push to DockerHub
          command: |
            source env-exports
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push "${DOCKER_TAG}"
